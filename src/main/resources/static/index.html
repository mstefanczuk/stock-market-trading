<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chat WebSocket</title>

    <script src="js/sockjs-0.3.4.js"></script>
    <script src="js/stomp.js"></script>

    <script type="text/javascript">

        let stompClient = null;
        let user;

        function connect() {
            const socket = new SockJS('/greeting');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                stompClient.subscribe("/user/queue/errors", function (message) {
                    showMessage(JSON.parse(message.body));
                });

                stompClient.subscribe("/user/queue/reply", function (message) {
                    showMessage(JSON.parse(message.body));
                })

                stompClient.subscribe("/topic/current-prices", function (message) {
                    showMessage(JSON.parse(message.body));
                });
            }, function (error) {
                showMessage({body: "STOMP error: " + error, time: new Date().toLocaleString()});
            });
        }

        function disconnect() {
            if (stompClient != null) {
                stompClient.close();
            }
        }

        function saveLimits() {
            const instruments = getInstruments();
            if (instruments.length > 0) {
                stompClient.send("/instrument/save", {}, JSON.stringify(instruments));
            }
        }

        async function login() {
            const login = document.getElementById('login-input').value;
            const response = await fetch('/user/save', {
                method: 'POST',
                body: login,
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            user = await response.json();
            showMessage({body: 'Zalogowano', time: new Date().toLocaleString()})
        }

        function showMessage(message) {
            const messageElement = document.getElementById('message');
            const p = document.createElement('p');
            p.style.wordWrap = 'break-word';
            p.appendChild(document.createTextNode(message.time + ": " + message.body));
            messageElement.appendChild(p);
        }

        function getInstruments() {
            let instruments = [];
            [
                {elementId: 'cdp-input', id: 1, name: 'CDPROJEKT'},
                {elementId: 'tesla-input', id: 2, name: 'TESLA'},
                {elementId: 'pge-input', id: 3, name: 'PGE'}
            ].forEach(instrumentData => {
                let instrument = getInstrument(instrumentData.elementId, instrumentData.id, instrumentData.name);
                if (instrument.limitation && instrument.limitation > 0) {
                    instruments.push(instrument);
                }
            })
            return instruments;
        }

        function getInstrument(elementId, instrumentId, instrumentName) {
            let limit = document.getElementById(elementId).value;
            return {
                user: {id: user.id, login: user.login},
                instrument: {id: instrumentId, name: instrumentName},
                limitation: limit,
                amount: 0,
                balance: 0
            };
        }
    </script>
</head>

<body onload="connect()">
<div>
    <input type="text" id="login-input" placeholder="Login"/>
    <button id="login-button" onclick="login();">Zaloguj</button>
    <table>
        <tr>
            <td><label for="cdp-input">CDPROJEKT</label></td>
            <td><input type="number" id="cdp-input" placeholder="Limit"/></td>
            <td><label for="cdp-amount">Liczba posiadanych jednostek:</label></td>
            <td>
                <div id="cdp-amount">0</div>
            </td>
        </tr>
        <tr>
            <td><label for="tesla-input">TESLA</label></td>
            <td><input type="number" id="tesla-input" placeholder="Limit"/></td>
            <td><label for="tesla-amount">Liczba posiadanych jednostek:</label></td>
            <td>
                <div id="tesla-amount">0</div>
            </td>
        </tr>
        <tr>
            <td><label for="pge-input">PGE</label></td>
            <td><input type="number" id="pge-input" placeholder="Limit"/></td>
            <td><label for="pge-amount">Liczba posiadanych jednostek:</label></td>
            <td>
                <div id="pge-amount">0</div>
            </td>
        </tr>
    </table>
    <br>
    <button id="save-limits-button" onclick="saveLimits();">Zapisz</button>
    <br>
</div>

<div>
    <p id="message"></p>
</div>

</body>
</html>
